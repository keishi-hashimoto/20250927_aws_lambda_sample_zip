name: Deploy
run-name: Deploy to lambda

on:
  push:
    branches: ["main"]

  workflow_dispatch:

defaults:
  run:
    shell: bash

permissions: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      id-token: write
    steps:
      - name: checkout
        uses: "actions/checkout@v5"
      - name: setup uv
        uses: "astral-sh/setup-uv@v6"
      - name: install python
        run: uv python install
      # アップロードするソースコードに不備が無いかを確認するために、作業ディレクトリ内でも自動テストを流す
      # 以下の 2 点の理由から、dist ディレクトリとは別にテスト専用のディレクトリを用意する
      # 1. テスト実行時に生成される pycache を artifacts に含めたくない
      # 2. テストに必要となる pytest などのパッケージを artifacts に含めたくない
      - name: create test dir
        run: mkdir tmp
      - name: copy source code to test dir
        run: cp src/* tmp/ -r
      - name: create requirements file
        # pytest などが必要なので --group dev を指定する
        run: uv pip compile pyproject.toml --group dev > requirements-dev.txt
      - name: install dependencies to test dir
        run: uv pip install -r requirements-dev.txt --target tmp
      - name: pytest
        run: |
          echo "${PYTHONPATH}"
          uv run pytest --no-sync
        env:
          PYTHONPATH: tmp
      - name: create artifacts dir
        run: mkdir dist
      - name: copy source code to artifacts dir
        run: cp src/* dist/ -r
      - name: create requirements file
        run: uv pip compile pyproject.toml > requirements.txt
      - name: install dependencies to artifacts dir
        run: uv pip install -r requirements.txt --target dist
      - name: configure aws credentials
        uses: "aws-actions/configure-aws-credentials@v4"
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: deploy to lambda
        uses: "aws-actions/aws-lambda-deploy@v1.1.0"
        with:
          function-name: ${{ secrets.LAMBDA_FUNCTION_NAME }}
          code-artifacts-dir: dist
          handler: my_func.my_handler
          runtime: python3.13
